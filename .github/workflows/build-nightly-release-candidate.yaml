name: Build Release Branch Nightly for TestPyPI

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  schedule:
    # Run from April 8th to April 13th at 02:00 UTC (10:00 PM EDT)
    - cron: "0 2 8-13 4 *"
  workflow_dispatch:

jobs:
  setup:
    name: Setup the release
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Catalyst repo release branch
      uses: actions/checkout@v4
      with:
        ref: v0.11.0-rc
        ssh-key: ${{ secrets.NIGHTLY_VERSION_UPDATE_DEPLOY_KEY }}

    - name: Bump RC version
      run: |
        python $GITHUB_WORKSPACE/.github/workflows/set_rc_version.py

  # Only build the most popular configurations on a nightly schedule to save PyPI storage.

  build-wheels:
    name: Build wheels
    needs: [setup]
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Catalyst repo release branch
      uses: actions/checkout@v4
      with:
        ref: v0.11.0-rc

    - name: linux-x86
      uses: ./.github/workflows/build-wheel-linux-x86_64.yaml

    - name: linux-aarch
      uses: ./.github/workflows/build-wheel-linux-arm64.yaml

    - name: macos-arm
      uses: ./.github/workflows/build-wheel-macos-arm64.yaml
