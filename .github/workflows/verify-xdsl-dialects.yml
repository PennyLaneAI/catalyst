name: Verify xDSL Dialects
on:
  workflow_dispatch:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  constants:
    name: Set Constants
    if: >-
      ${{
        ( github.event_name == 'pull_request'
        && github.event.pull_request.draft == false
        && contains(github.event.pull_request.labels.*.name, 'unified compiler') )
        || github.event_name == 'workflow_dispatch'
      }}
    uses: ./.github/workflows/constants.yaml
    with:
      runs_on: ubuntu-24.04

  compare-dialects:
    name: Compare xDSL and MLIR Dialects
    needs: constants
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        compiler: ${{ fromJson(needs.constants.outputs.compilers) }}

    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ needs.constants.outputs.primary_python_version }}

    - name: Checkout Catalyst
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref }}
        submodules: true
        fetch-depth: 0

    - name: Install Catalyst and Dependencies
      env:
        BRANCH: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.ref }}
      run: |
        # Install Catalyst. We only want the frontend to be usable, so we use a minimal
        # source build using TestPyPI wheels
        # 1. Create Python environment
        python -m venv .venv

        # 2. Install Catalyst
        echo "y" | bash ./setup_dev_from_wheel.sh ./.venv $BRANCH

        # 3. Activate Python environment
        source ./.venv/bin/activate

        # ruff is a dependency for the xdsl-tblgen CLI tool. Generally, it gets installed if
        # installing xdsl[dev], but we install it separately to simplify dependency installation
        python -m pip install ruff

    # We get the cached LLVM build after installing Catalyst so that the diff does not impact
    # the Catalyst installation process
    - name: Get Cached LLVM Build
      id: cache-llvm-build
      uses: actions/cache/restore@v4
      with:
        path: llvm-build
        key: ${{ runner.os }}-llvm-${{ needs.constants.outputs.llvm_version }}-ci-build-${{ matrix.compiler }}
        fail-on-cache-miss: true

    - name: Create Python Dialects
      run: |
        OPTIONS="--llvm-build $(pwd)/llvm-build --catalyst-root $GITHUB_WORKSPACE --save-path $(pwd)/gen_dialects"
        python $GITHUB_WORKSPACE/.github/workflows/xdsl_scripts/create_xdsl_dialects.py $OPTIONS

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gen_dialects
        path: gen_dialects

    - name: Verify Python Dialects
      run: |
        OPTIONS="--save-path $(pwd)/gen_dialects"
        python $GITHUB_WORKSPACE/.github/workflows/xdsl_scripts/verify_xdsl_dialects.py $OPTIONS


